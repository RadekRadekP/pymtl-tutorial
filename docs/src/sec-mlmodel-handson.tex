%=========================================================================
% Hands-On: GCD Unit
%=========================================================================

\stepcounter{taskseccount}
\section[{\it Hands-On} GCD Unit]{}
\scheduleslide{9}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: The GCD Unit}
%-------------------------------------------------------------------------
\begin{itemize}
  \item Computes the greatest-common divisor of two numbers.
  \smallskip
  \item Uses a latency insensitive input protocol to accept messages only
        when sender has data available and GCD unit is ready.
  \smallskip
  \item Uses a latency insensitive output protocol to send results only
        when result is done and receiver is ready.
\end{itemize}

  \cbxfigc{tut3-gcd-fl.svg.pdf}
\end{frame}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Bundled Interfaces}
%-------------------------------------------------------------------------
\vspace{-0.18in}
\begin{itemize}
  \item \BF{PortBundles} are used to simplify the handling of multi-signal
        interfaces, such as ValRdy:
\end{itemize}

\vspace{-0.15in}
\lstinputlisting[xleftmargin={0.38in},firstline=14,lastline=27,numbers=none]
{../../slide_examples/Bundles.py}

\end{frame}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Complex Datatypes}
%-------------------------------------------------------------------------
\vspace{-0.18in}
\begin{itemize}
  \item \BF{BitStructs} are used to simplify communicating and interacting
        with complex packages of data:
\end{itemize}

\vspace{-0.15in}
\lstinputlisting[xleftmargin={0.38in},firstline=9,lastline=22,numbers=none]
{../../slide_examples/Structs_test.py}

\end{frame}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Complex Datatypes}
%-------------------------------------------------------------------------

The GCD request message can be implemented as a BitStruct that has two
fields, one for each operand:

\vspace{.2in}
\cbxfigc{tut3-gcd-bitstruct.svg.pdf}
\end{frame}

%-------------------------------------------------------------------------
\begin{task}\begin{frame}[fragile]{Create a BitStruct for the GCD request}
%-------------------------------------------------------------------------
\vspace{-0.25in}
\begin{verbatim}
  % cd    ~/pymtl-tutorial/build
  % gedit ../gcd/GcdUnitMsg.py
\end{verbatim}

\lstinputlisting[xleftmargin={0.38in},firstline=12,lastline=19,firstnumber=12]%
{../../gcd_soln/GcdUnitMsg.py}

\begin{verbatim}
  % py.test ../gcd/GcdUnitMsg_test.py -v
\end{verbatim}
\end{frame}
\end{task}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Latency Insensitive FL Models}
%-------------------------------------------------------------------------
\begin{itemize}
  \item Implementing latency insensitive communication protocols can be
        complex to implement and a challenge to debug.
  \smallskip
  \item PyMTL provides \BF{Interface Adapters} which abstract away the
        complexities of ValRdy, and expose simplified method interfaces.
\end{itemize}

  \begin{onlyenv}<1>
    \cbxfigc<1>{tut3-gcd-queues.svg.pdf}
  \end{onlyenv}

  \begin{onlyenv}<2>
  \vspace{-0.15in}
  \lstinputlisting[xleftmargin={0.38in},firstline=19,lastline=27,firstnumber=19]%
  {../../gcd/GCDUnitFL.py}
  \end{onlyenv}

\end{frame}

%-------------------------------------------------------------------------
\begin{task}\begin{frame}[fragile]{Build an FL model for the GCD unit}
%-------------------------------------------------------------------------
\vspace{-0.25in}
\begin{verbatim}
  % cd    ~/pymtl-tutorial/build
  % gedit ../gcd/GcdUnitFL.py
\end{verbatim}

\lstinputlisting[xleftmargin={0.38in},firstline=31,lastline=41,firstnumber=31]%
{../../gcd_soln/GcdUnitFL.py}

\begin{verbatim}
  % py.test ../gcd/GcdUnitFL_test.py -v
\end{verbatim}
\end{frame}
\end{task}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Testing Latency Insensitive Models}
%-------------------------------------------------------------------------

\begin{itemize}
  \item To simplify testing of latency insensitive designs, PyMTL provides
        TestSources and TestSinks with ValRdy interfaces.
  \smallskip
  \item TestSources/TestSinks only transmit/accept data when the ``design
        under test'' is ready/valid.
  \smallskip
  \item Can be configured to insert random delays into valid/ready signals
        to verify latency insensitivity under various conditions.
\end{itemize}

  \cbxfigc{tut3-gcd-srcsink.svg.pdf}
\end{frame}

%-------------------------------------------------------------------------
\begin{task}\begin{frame}[fragile]{Create a latency insensitive test}
%-------------------------------------------------------------------------
\vspace{-0.25in}
\begin{verbatim}
  % cd    ~/pymtl-tutorial/build
  % gedit ../gcd/GcdUnitFL_simple_test.py
\end{verbatim}

\lstinputlisting[xleftmargin={0.38in},firstline=22,lastline=31,firstnumber=22]%
{../../gcd_soln/GcdUnitFL_simple_test.py}

\begin{verbatim}
  % py.test ../gcd/GcdUnitFL_simple_test.py -v -s
\end{verbatim}
\end{frame}
\end{task}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Latency Insensitive CL Models}
%-------------------------------------------------------------------------
\vspace{-0.25in}
\lstinputlisting[xleftmargin={0.38in},firstline=1,lastline=16,numbers=none]%
{../../gcd_soln/fl_trace.out}

\end{frame}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Latency Insensitive CL Models}
%-------------------------------------------------------------------------

\begin{itemize}
  \item Cycle-level models add timing information to a functional model
        and can provide a cycle-approximate estimation of performance.
  \smallskip
  \item Useful for rapid, initial exploration of an
        architectural design space.
  \smallskip
  \item We'll use a simple GCD algorithm to provide timing info.
\end{itemize}

  \cbxfigc{tut3-gcd-cl.svg.pdf}
\end{frame}

%-------------------------------------------------------------------------
\begin{task}\begin{frame}[fragile]{Add timing to the GCD CL model}
%-------------------------------------------------------------------------
\vspace{-0.25in}
\begin{verbatim}
  % cd    ~/pymtl-tutorial/build
  % py.test ../gcd/GcdUnitCL_test.py
  % py.test ../gcd/GcdUnitCL_test.py -k basic_0x0 -sv
  % gedit ../gcd/GcdUnitCL.py
\end{verbatim}

\vspace{-0.1in}
\lstinputlisting[xleftmargin={0.38in},firstline=17,lastline=25,firstnumber=17]%
{../../gcd_soln/GcdUnitCL.py}

\begin{verbatim}
  % py.test ../gcd/GcdUnitCL_test.py -k basic_0x0 -sv
\end{verbatim}
\end{frame}
\end{task}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Latency Insensitive CL Models}
%-------------------------------------------------------------------------
\vspace{-0.25in}
\lstinputlisting[xleftmargin={0.38in},firstline=1,lastline=16,numbers=none]%
{../../gcd_soln/cl_trace.out}

\end{frame}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Latency Insensitive RTL Models}
%-------------------------------------------------------------------------

\begin{itemize}
  \item RTL models allow us to accurately estimate executed cycles,
        cycle-time, area and energy when used with an EDA toolflow.
  \smallskip
  \item Constructing is time consuming! PyMTL tries to make it it more
        productive by providing a better design and testing environment.
\end{itemize}

  \begin{cbxcols}
  \begin{column}{0.5\tw}
  \cbxfigc[0.75\tw]{tut3-gcd-ctrl.svg.pdf}
  \end{column}
  \begin{column}{0.5\tw}
  \cbxfigc{tut3-gcd-dpath.svg.pdf}
  \end{column}
  \end{cbxcols}
\end{frame}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Latency Insensitive RTL Models}
%-------------------------------------------------------------------------

\begin{itemize}
  \item Latency insensitive hardware generally separates logic into
        control and datapath (shown below).
  \smallskip
  \item Today, we won’t be writing RTL for GCD, but we’ll be fixing a bug
        in the RTL implementation of the state machine.
\end{itemize}

  \begin{cbxcols}
  \begin{column}{0.5\tw}
  \cbxfigc[0.75\tw]{tut3-gcd-ctrl-broken.svg.pdf}
  \end{column}
  \begin{column}{0.5\tw}
  \cbxfigc{tut3-gcd-dpath.svg.pdf}
  \end{column}
  \end{cbxcols}
\end{frame}


%-------------------------------------------------------------------------
\begin{task}\begin{frame}[fragile]{Fix the bug in the GCD RTL model}
%-------------------------------------------------------------------------
\vspace{-0.25in}
\begin{verbatim}
  % cd    ~/pymtl-tutorial/build
  % py.test ../gcd/GcdUnitRTL_test.py -k basic_0x0 -sv
  % gedit ../gcd/GcdUnitRTL.py
\end{verbatim}

\vspace{-0.2in}
\lstinputlisting[xleftmargin={0.38in},firstline=183,lastline=194,firstnumber=183]%
{../../gcd/GcdUnitRTL.py}

\vspace{-0.3in}
\begin{verbatim}
  % py.test ../gcd/GcdUnitRTL_test.py -k basic_0x0 -sv
\end{verbatim}
\end{frame}
\end{task}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL 102: Latency Insensitive RTL Models}
%-------------------------------------------------------------------------
\vspace{-0.25in}
\lstinputlisting[xleftmargin={0.38in},firstline=1,lastline=16,numbers=none]%
{../../gcd_soln/rtl_trace.out}

\end{frame}

%-------------------------------------------------------------------------
\begin{task}\begin{frame}[fragile]{Verify generated Verilog GCD RTL}
%-------------------------------------------------------------------------
\vspace{-0.25in}
\begin{verbatim}
  % cd    ~/pymtl-tutorial/build
  % py.test ../gcd/GcdUnitRTL_test.py --test-verilog -sv
  % gedit GcdUnitRTL_0x791afe0d4d8c.v
\end{verbatim}

\vspace{-0.3in}
\lstinputlisting[xleftmargin={0.38in},firstline=6,lastline=19,firstnumber=4]%
{../../gcd_soln/GcdUnitRTL_0x791afe0d4d8c.v}
\end{frame}
\end{task}

%-------------------------------------------------------------------------
\begin{task}\begin{frame}[fragile]{Experiment with the GCD simulator}
%-------------------------------------------------------------------------
\vspace{-0.25in}
\begin{verbatim}
  # Simulating both the CL and RTL models

  % cd    ~/pymtl-tutorial/build
  % ../gcd/gcd-sim --stats --impl --cl  --input random
  % ../gcd/gcd-sim --stats --impl --rtl --input random

  # Experimenting with various datasets

  % ../gcd/gcd-sim --impl rtl --input random --trace
  % ../gcd/gcd-sim --impl rtl --input small  --trace
  % ../gcd/gcd-sim --impl rtl --input zeros  --trace

\end{verbatim}
\end{frame}
\end{task}

%-------------------------------------------------------------------------
\begin{frame}{PyMTL Next Steps and More Resources}
%-------------------------------------------------------------------------
Next Steps:
\begin{itemize}
  \item See the detailed tutorial on the Cornel ECE5745 website:
        \footnotesize{http://www.csl.cornell.edu/courses/ece5745/handouts/ece5745-tut-pymtl.pdf}
\end{itemize}

\smallskip
Check out the \BF{/docs} directory in the PyMTL repo for guides on:
\begin{itemize}
  \item Writing Pythonic PyMTL Models and Tests
  \item Writing Verilog Translatable PyMTL RTL
  \item Importing Verilog Components into PyMTL
\end{itemize}

\smallskip
Become a contributor!
\begin{itemize}
  \item https://github.com/cornell-brg/pymtl
  \item https://github.com/cornell-brg/pydgin
\end{itemize}
\end{frame}

%-------------------------------------------------------------------------
\begin{frame}{Thank you for coming!}
%-------------------------------------------------------------------------
  \begin{cbxcols}
  \begin{column}{0.5\tw}
  \vspace{.2in}
  \cbxfigc{pymtl-flat.svg.pdf}

  \vspace{.3in}
  \centering{PyMTL: A Unified Framework for Vertically Integrated Computer
  Architecture Research}

  \vspace{.363in}
  \centering{[ MICRO 2014 ]}
  \centering{\footnotesize{https://github.com/cornell-brg/pymtl}}
  \end{column}

  \begin{column}{0.5\tw}
  \vspace{.2in}
  \cbxfigc{pydgin-flat.svg.pdf}

  \vspace{.3in}
  \centering{Pydgin: Generating Fast Instruction Set Simulators from
  Simple Architecture Descriptions with Meta-Tracing JIT Compilers}

  \vspace{.2in}
  \centering{[ ISPASS 2015 ]}
  \centering{\footnotesize{https://github.com/cornell-brg/pydgin}}

  \end{column}
  \end{cbxcols}
\end{frame}
